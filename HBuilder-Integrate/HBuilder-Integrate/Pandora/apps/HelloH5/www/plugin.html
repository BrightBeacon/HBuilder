<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        <meta name="HandheldFriendly" content="true"/>
        <meta name="MobileOptimized" content="320"/>
        <title>H5Plugin</title>
        <script type="text/javascript" src="./js/common.js"></script>
        <script type="text/javascript" src="jsaip/pdr.js"></script>>
        <script type="text/javascript" src="ibeacon.js"></script>

        <script type="text/javascript">
            // H5 plus事件处理
            function plusReady(){
                switch ( plus.os.name ) {
                    case "iOS":
                    // 导入类
                    startMonitoringForRegion();
                    break;
                }
            }
        if(window.plus){
            plusReady();
        }else{
            document.addEventListener("plusready",plusReady,false);
        }
        function startRangingBeaconsInRegion() {
            plus.iBeacon.startRangingBeaconsInRegion({"uuid":"FDA50693-A4E2-4FB1-AFCF-C6EB07647825"},function(result){
                                                        var cont = document.getElementById('list');
                                                        var htmlcode = JSON.stringify(result);
                                                        cont.innerHTML = htmlcode;
                                                     });
        }
        
        function isRangingAvailable()
        {
            plus.iBeacon.isRangingAvailable(function(result){
                                                        if(result.error)alert(result.message);
                                                        else alert("支持");
                                                     });
        }
        
        
        function stopRangingBeaconsInRegion()
        {
            plus.iBeacon.stopRangingBeaconsInRegion({"uuid":"FDA50693-A4E2-4FB1-AFCF-C6EB07647825"});
        }
        
        
        function startMonitoringForRegion()
        {
            plus.iBeacon.startMonitoringForRegion({"uuid":"FDA50693-A4E2-4FB1-AFCF-C6EB07647825","in":1,"out":1,"display":1},function(result){
                                                  var cont = document.getElementById('list');
                                                  var htmlcode = JSON.stringify(result);
                                                  cont.innerHTML = htmlcode;
                                                  sendLocalNotification();
                                            });
        }
        
        
        function stopMonitoringForRegion()
        {
            plus.iBeacon.stopMonitoringForRegion({"uuid":"FDA50693-A4E2-4FB1-AFCF-C6EB07647825"});
        }
        
        
        function requestAlwaysAuthorization()
        {
            plus.iBeacon.requestAlwaysAuthorization(function(result){
                                                    var cont = document.getElementById('list');
                                                    var htmlcode = JSON.stringify(result);
                                                    cont.innerHTML = htmlcode;
                                                    });
        }
        
        function requestWhenInUseAuthorization()
        {
            plus.iBeacon.requestWhenInUseAuthorization(function(result){
                                                    var cont = document.getElementById('list');
                                                    var htmlcode = JSON.stringify(result);
                                                    cont.innerHTML = htmlcode;
                                                    });
        }
        
        function rangedRegions()
        {
            plus.iBeacon.rangedRegions(function(result){
                                                    var cont = document.getElementById('list');
                                                    var htmlcode = JSON.stringify(result);
                                                    cont.innerHTML = htmlcode;
                                                    });
        }
        
        function monitoredRegions()
        {
            plus.iBeacon.monitoredRegions(function(result){
                                          var cont = document.getElementById('list');
                                          var htmlcode = JSON.stringify(result);
                                          cont.innerHTML = htmlcode;
                                          });
        }
        function requestStateForRegion()
        {
            plus.iBeacon.requestStateForRegion({"uuid":"FDA50693-A4E2-4FB1-AFCF-C6EB07647825"},function(result){
                                               var cont = document.getElementById('list');
                                               var htmlcode = JSON.stringify(result);
                                               cont.innerHTML = htmlcode;
                                               });
        }
        function registerLocalNotification()
        {
            plus.iBeacon.registerLocalNotification();
        }
        function sendLocalNotification()
        {
            plus.iBeacon.sendLocalNotification({"title":"标题","subtitle":"副标题","info":{"hidden":"message"}});
        }
        function onAppStartByLocalNotification()
        {
            plus.iBeacon.onAppStartByLocalNotification(function(result){
                                                       var cont = document.getElementById('list');
                                                       var htmlcode = JSON.stringify(result);
                                                       cont.innerHTML = htmlcode;
                                                       });
        }
        function startAdvertising()
        {
            plus.iBeacon.startAdvertising({"uuid":"FDA50693-A4E2-4FB1-AFCF-C6EB07647825","major":65535,"minor":0,"identifier":"test","measuredpower":-60},function(result){
                                                       var cont = document.getElementById('list');
                                                       var htmlcode = JSON.stringify(result);
                                                       cont.innerHTML = htmlcode;
                                                       });
        }
        function stopAdvertising()
        {
            plus.iBeacon.stopAdvertising();
        }
        function scanForPeripheralsWithServices()
        {
            plus.iBeacon.scanForPeripheralsWithServices(null,function(ble){
                                                            plus.iBeacon.stopScan();
                                                            var cont = document.getElementById('list');
                                                            var htmlcode = JSON.stringify(ble);
                                                            cont.innerHTML = htmlcode;
                                                            //连接设备
                                                                plus.iBeacon.connectPeripheral(ble.peripheral,function(result){
                                                                    if(result.error) {
                                                                        cont.innerHTML = result.message;
                                                                    }else{
                                                                        cont.innerHTML = cont.innerHTML+"<br/>"+JSON.stringify(result);
                                                                        for (var i = result.characteristics.length - 1; i >= 0; i--) {
                                                                            var characteristic = result.characteristics[i];
                                                                            if (characteristic.indexOf("E24BF792")!=-1) {
                                                                                //读取特征值，E24BF792仅为测试特征，请自行填入实际ble设备特征
                                                                                plus.iBeacon.readPeripheralCharacteristic(ble.peripheral,characteristic,function(rlt) {
                                                                                    if(!rlt.error)cont.innerHTML = rlt.data;
                                                                                    plus.iBeacon.disconnectPeripheral(ble.peripheral);
                                                                                });
                                                                                // 写入特征值
                                                                                // plus.iBeacon.writePeripheralCharacteristic(ble.peripheral,characteristic,"FFFF",1,function(rlt){
                                                                                //     if(!rlt.error)cont.innerHTML = rlt.data;
                                                                                //     plus.iBeacon.disconnectPeripheral(ble.peripheral);
                                                                                // });
                                                                            }
                                                                        }
                                                                    }
                                                                });
                                                       });
        }
        function stopScan()
        {
            plus.iBeacon.stopScan();
        }
            </script>
        <link rel="stylesheet" href="./css/common.css" type="text/css" charset="utf-8"/>
    </head>
    <body>
        <header>
            <div class="nvtt">HBuilder-Plugin</div>
        </header>
        <div id="dcontent" class="dcontent">
            <br/>
            <div class="button" onclick="isRangingAvailable()">是否支持扫描</div>
            <div class="button" onclick="startRangingBeaconsInRegion()">iBeacon扫描</div>
            <div class="button" onclick="stopRangingBeaconsInRegion()">停止iBeacon扫描</div>
            <div class="button" onclick="startMonitoringForRegion()">区域监听</div>
            <div class="button" onclick="stopMonitoringForRegion()">停止区域监听</div>
            <div class="button" onclick="requestAlwaysAuthorization()">手动请求后台和运行时定位权限</div>
            <div class="button" onclick="requestWhenInUseAuthorization()">手动请求运行时定位权限</div>
            <div class="button" onclick="rangedRegions()">当前扫描区域</div>
            <div class="button" onclick="monitoredRegions()">当前监听区域</div>
            <div class="button" onclick="requestStateForRegion()">获取区域状态</div>
            <div class="button" onclick="registerLocalNotification()">如需发通知，请求权限</div>
            <div class="button" onclick="sendLocalNotification()">发送通知</div>
            <div class="button" onclick="onAppStartByLocalNotification()">获取点击通知信息</div>
            <div class="button" onclick="startAdvertising()">广播iBeacon</div>
            <div class="button" onclick="stopAdvertising()">停止广播iBeacon</div>
            <div class="button" onclick="scanForPeripheralsWithServices()">扫描-连接蓝牙设备</div>
            <div class="button" onclick="stopScan()">停止扫描</div>
            <br/>
            <div id="list">
            </div>
        </div>
    </body>
</html>
